<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ChatHub</title>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #e0e0e0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .header {
      background: #6C63FF;
      color: white;
      padding: 15px;
      text-align: center;
      position: relative;
      font-size: 20px;
    }
    .logout {
      position: absolute;
      right: 20px;
      top: 15px;
      background: #ff4b5c;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 12px;
    }
    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .message {
      max-width: 60%;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 15px;
      position: relative;
      animation: fadeIn 0.5s;
      word-wrap: break-word;
    }
    .message.own {
      align-self: flex-end;
      background: #6C63FF;
      color: white;
    }
    .message.other {
      align-self: flex-start;
      background: #ffffff;
      color: #333;
    }
    .message span {
      font-size: 10px;
      opacity: 0.7;
      display: block;
      margin-top: 5px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .typing {
      font-style: italic;
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    .input-box {
      display: flex;
      padding: 10px;
      background: #e0e0e0;
    }
    .input-box input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 10px;
      margin-right: 10px;
      box-shadow: inset 5px 5px 10px #bebebe,
                  inset -5px -5px 10px #ffffff;
      outline: none;
    }
    .input-box button {
      padding: 10px 15px;
      background: #6C63FF;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="header">
  ChatHub
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div id="chatBox" class="chat-box"></div>
<div id="typing" class="typing" style="display: none;">Someone is typing...</div>

<div class="input-box">
  <input id="messageInput" type="text" placeholder="Type a message...">
  <button onclick="sendMessage()">Send</button>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, set, serverTimestamp, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCe6ZDW_1dUn9WCnrls_9Y5ookztnf_0Zs",
    authDomain: "chathub-25042025.firebaseapp.com",
    databaseURL: "https://chathub-25042025-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chathub-25042025",
    storageBucket: "chathub-25042025.appspot.com",
    messagingSenderId: "616104747114",
    appId: "1:616104747114:web:6f981f3cdc93199126aa13",
    measurementId: "G-GFPB602T33"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const username = localStorage.getItem('username');
  if (!username) {
    window.location.href = 'login.html';
  }

  const chatBox = document.getElementById('chatBox');
  const messageInput = document.getElementById('messageInput');
  const typingDiv = document.getElementById('typing');

  const messagesRef = ref(db, "messages");
  const typingRef = ref(db, "typing/" + username);

  messageInput.addEventListener('input', () => {
    if (messageInput.value.trim() !== "") {
      set(typingRef, true);
    } else {
      remove(typingRef);
    }
  });

  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  onChildAdded(messagesRef, (data) => {
    const msg = data.val();
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + (msg.username === username ? 'own' : 'other');
    messageDiv.innerHTML = `<b>${msg.username}</b><br>${msg.text}<span>${new Date(msg.timestamp).toLocaleTimeString()}</span>`;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  function sendMessage() {
    const text = messageInput.value.trim();
    if (text !== "") {
      push(messagesRef, {
        username,
        text,
        timestamp: Date.now()
      });
      messageInput.value = "";
      remove(typingRef);
    }
  }

  function logout() {
    localStorage.removeItem('username');
    window.location.href = 'login.html';
  }

  const typingStatusRef = ref(db, "typing");
  onChildAdded(typingStatusRef, (snapshot) => {
    if (snapshot.key !== username) {
      typingDiv.style.display = 'block';
    }
  });

  onDisconnect(typingRef).remove();

  import { onChildRemoved } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
  onChildRemoved(typingStatusRef, (snapshot) => {
    typingDiv.style.display = 'none';
  });
</script>

</body>
</html>
